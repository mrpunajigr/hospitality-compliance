"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5552],{1811:(e,r,t)=>{t.d(r,{BP:()=>b,HK:()=>m,FX:()=>h,tB:()=>f,supabase:()=>U});var n=t(5647),a=t(9535),i=t(9509);let s="https://rggdywqnvpuwssluzfud.supabase.co",o="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJnZ2R5d3FudnB1d3NzbHV6ZnVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzOTIwMTAsImV4cCI6MjA2OTk2ODAxMH0.j1AiBUEfjqVxLu8ARtH5B_DBKI1dg2EKgp_VZtprAzg";if(!s||!o)throw Error("Missing Supabase environment variables. Please ensure NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY are set.");let l=(0,a.createBrowserClient)(s,o),c=i.env.NEXT_PUBLIC_SUPABASE_SERVICE_ROLE_KEY||i.env.SUPABASE_SERVICE_ROLE_KEY;c&&(0,n.UU)(s,c,{auth:{autoRefreshToken:!1,persistSession:!1}});let u="delivery-dockets",d=new Map,g=async function(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3600;if(arguments.length>2&&arguments[2],!e||""===e.trim()||"null"===e||"undefined"===e)return"";try{let t=e.split("/").pop()||e;console.log("\uD83D\uDD0D Generating signed URL for:",t),console.log("\uD83D\uDD0D Using bucket:",u),console.log("\uD83D\uDD0D Original path:",e);let{data:n,error:a}=await l.storage.from(u).list("",{limit:100});console.log("\uD83D\uDD0D Files in bucket:",(null==n?void 0:n.map(e=>e.name))||[]),console.log("\uD83D\uDD0D Looking for file:",t);let i=l.storage.from(u).createSignedUrl(t,r),{data:s,error:o}=await new Promise((e,r)=>{let t=setTimeout(()=>{r(Error("Timeout after ".concat(1e4,"ms")))},1e4);i.then(e).catch(r).finally(()=>clearTimeout(t))});if(o)return console.error("❌ Signed URL generation failed:",o),"";if(null==s?void 0:s.signedUrl)return console.log("✅ Signed URL generated:",s.signedUrl),s.signedUrl;return console.log("❌ No signed URL returned from Supabase"),""}catch(e){return console.error("❌ Signed URL exception:",e),""}},m=async(e,r)=>await g(e,3600,r),f=async(e,r)=>{let{data:t,error:n}=await l.from("client_users").select("role").eq("user_id",e).eq("client_id",r).eq("status","active").single();return n?(console.error("Error fetching user role:",n),null):(null==t?void 0:t.role)||null},h=async function(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:50,t="delivery-records-".concat(e,"-").concat(r);if(d.has(t))return d.get(t);let n=(async()=>{try{let t=new AbortController,n=setTimeout(()=>t.abort(),3e4),a=await fetch("/api/delivery-records?clientId=".concat(e,"&limit=").concat(r),{signal:t.signal});if(clearTimeout(n),!a.ok)throw Error("HTTP ".concat(a.status,": Failed to fetch delivery records"));let i=await a.json();if(!i.success)throw Error(i.error||"Failed to fetch delivery records");return i.data||[]}catch(r){return r instanceof Error&&"AbortError"===r.name?console.error("⏰ Delivery records request timed out for clientId:",e):console.error("❌ Error fetching delivery records for clientId:",e,r),[]}finally{d.delete(t)}})();return d.set(t,n),n},b=async e=>{let r="compliance-alerts-".concat(e);if(d.has(r))return d.get(r);let t=(async()=>{try{let r=new AbortController,t=setTimeout(()=>r.abort(),3e4),n=await fetch("/api/compliance-alerts?clientId=".concat(e),{signal:r.signal});if(clearTimeout(t),!n.ok)return console.warn("⚠️ Compliance alerts API not configured for demo mode"),[];let a=await n.json();if(!a.success)return[];return a.data||[]}catch(e){return e instanceof Error&&"AbortError"===e.name?console.warn("⏰ Compliance alerts request timed out"):console.warn("⚠️ Compliance alerts not available in demo mode"),[]}finally{d.delete(r)}})();return d.set(r,t),t};var y=t(9509);let w=null;try{let e="https://rggdywqnvpuwssluzfud.supabase.co",r="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJnZ2R5d3FudnB1d3NzbHV6ZnVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzOTIwMTAsImV4cCI6MjA2OTk2ODAxMH0.j1AiBUEfjqVxLu8ARtH5B_DBKI1dg2EKgp_VZtprAzg",t=y.env.SUPABASE_SERVICE_ROLE_KEY;e&&r&&(w=(0,n.UU)(e,r,{auth:{persistSession:!0,autoRefreshToken:!0,storageKey:"hospitality-compliance-auth"}})),e&&t&&(0,n.UU)(e,t,{auth:{autoRefreshToken:!1,persistSession:!1}})}catch(e){console.warn("Supabase client initialization failed:",e instanceof Error?e.message:"Unknown error")}let U=w;console.log("\uD83D\uDE80 Database Core lib loaded - Modular Architecture v1.8.19")},1896:(e,r,t)=>{t.r(r),t.d(r,{getUserClient:()=>a,userHasClientAccess:()=>i});var n=t(1811);async function a(e){try{let{data:r,error:t}=await n.supabase.from("client_users").select("\n        client_id,\n        role,\n        status,\n        clients (\n          id,\n          name\n        )\n      ").eq("user_id",e).eq("status","active").single();if(t||!r||!r.clients)return t?console.log("ℹ️ User client lookup result:",t.message||"No client association found"):console.log("ℹ️ User has no active client association"),null;let a=Array.isArray(r.clients)?r.clients[0]:r.clients,{data:i,error:s}=await n.supabase.from("clients").select("*").eq("id",a.id).single();if(s)return console.log("ℹ️ Client details lookup result:",s.message||"Unable to fetch extended client details"),{id:a.id,name:a.name,role:r.role,status:r.status};return{id:a.id,name:a.name,role:r.role,status:r.status,business_type:i.business_type,business_email:i.business_email,phone:i.phone,address:i.address,license_number:i.license_number,subscription_status:i.subscription_status,subscription_tier:i.subscription_tier,onboarding_status:i.onboarding_status,estimated_monthly_deliveries:i.estimated_monthly_deliveries}}catch(e){return console.log("ℹ️ getUserClient exception:",e instanceof Error?e.message:"Unknown error occurred"),null}}async function i(e,r){try{let{data:t,error:a}=await n.supabase.from("client_users").select("id").eq("user_id",e).eq("client_id",r).eq("status","active").single();return!a&&!!t}catch(e){return!1}}},5552:(e,r,t)=>{t.d(r,{LE:()=>n.getUserClient});var n=t(8407);t(1896)},8407:(e,r,t)=>{async function n(){try{let{getAuthenticationCore:e}=await t.e(3249).then(t.bind(t,3249)),r=e();if(r.isLoaded&&r.isActive)return r.getCapabilityInterface("authentication")}catch(e){console.warn("⚠️ Authentication Core not available, falling back to legacy:",e)}try{return await Promise.resolve().then(t.bind(t,1896))}catch(e){throw console.error("❌ Both modular and legacy auth systems unavailable:",e),e}}async function a(){try{let e=await Promise.resolve().then(t.bind(t,1896));return await e.getProfileManagementCapability()}catch(e){console.warn("⚠️ Profile Management not available from legacy, trying core module");try{let{getAuthenticationCore:e}=await t.e(3249).then(t.bind(t,3249)),r=e();if(r.isLoaded&&r.isActive)return r.getCapabilityInterface("profile-management")}catch(e){console.warn("⚠️ Profile Management not available from core module")}}try{let e=await Promise.resolve().then(t.bind(t,1896));return{getUserProfile:e.getUserClient,updateUserProfile:e.updateUserProfile||(()=>Promise.resolve({success:!1,error:"Not implemented in legacy"}))}}catch(e){throw console.error("❌ Profile management unavailable:",e),e}}async function i(e){try{var r;let t=await n();if(t.getUserClient)return await t.getUserClient(e);if(null==(r=t.default)?void 0:r.getUserClient)return await t.default.getUserClient(e);if("object"==typeof t&&t.getUserClient)return await t.getUserClient(e);return console.error("❌ getUserClient function not found in auth capability"),null}catch(r){console.error("❌ Error in bridged getUserClient:",r);try{let r=await Promise.resolve().then(t.bind(t,1896));return await r.getUserClient(e)}catch(e){return console.error("❌ Legacy fallback failed:",e),null}}}async function s(e){try{let r=await n();if(r.createUserClient)return await r.createUserClient(e);let a=await Promise.resolve().then(t.bind(t,1896));if(a.createUserClient)return await a.createUserClient(e);return{success:!1,error:"createUserClient not available"}}catch(e){return console.error("❌ Error in bridged createUserClient:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function o(e,r){try{let t=await a();if(t.updateUserProfile)return await t.updateUserProfile(e,r);return{success:!1,error:"updateUserClient not available"}}catch(e){return console.error("❌ Error in bridged updateUserClient:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function l(e){try{let r=await n();if(r.getUserPermissions)return await r.getUserPermissions(e);let t=await i(e);return(null==t?void 0:t.permissions)||[]}catch(e){return console.error("❌ Error in bridged getUserPermissions:",e),[]}}async function c(e,r){try{let t=await l(e);return t.includes(r)||t.includes("*")}catch(e){return console.error("❌ Error checking permission:",e),!1}}async function u(e,r){try{let a=await n();if(a.signIn)return await a.signIn(e,r);let i=await Promise.resolve().then(t.bind(t,1896));if(i.signInUser)return await i.signInUser(e,r);return{success:!1,error:"Sign in functionality not available"}}catch(e){return console.error("❌ Error in bridged signInUser:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function d(){try{let e=await n();if(e.signOut)return await e.signOut();let r=await Promise.resolve().then(t.bind(t,1896));if(r.signOutUser)return await r.signOutUser();return{success:!1,error:"Sign out functionality not available"}}catch(e){return console.error("❌ Error in bridged signOutUser:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function g(){try{let e=await n();if(e.getCurrentUser)return await e.getCurrentUser();let{supabase:r}=await Promise.resolve().then(t.bind(t,1811)),{data:{user:a}}=await r.auth.getUser();return a}catch(e){return console.error("❌ Error in bridged getCurrentUser:",e),null}}async function m(){try{let{getAuthenticationCore:e}=await t.e(3249).then(t.bind(t,3249)),r=e();if(r.isLoaded&&r.isActive)return r.getCapabilityInterface("team-management")}catch(e){console.warn("⚠️ Team Management not available from module")}return{getTeamMembers:async e=>{try{let r=await Promise.resolve().then(t.bind(t,1896));return await r.getTeamMembers(e)}catch(e){return[]}},addTeamMember:async(e,r)=>({success:!1,error:"Team management not available in legacy mode"}),removeTeamMember:async(e,r)=>({success:!1,error:"Team management not available in legacy mode"})}}async function f(e){try{let r=await m();return await r.getTeamMembers(e)}catch(e){return console.error("❌ Error getting team members:",e),[]}}async function h(e,r){try{let t=await m();return await t.addTeamMember(e,r)}catch(e){return console.error("❌ Error adding team member:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function b(e,r){try{let t=await m();return await t.removeTeamMember(e,r)}catch(e){return console.error("❌ Error removing team member:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function y(){try{let{getAuthenticationCore:e}=await t.e(3249).then(t.bind(t,3249)),r=e();return r.isLoaded&&r.isActive}catch(e){return!1}}async function w(){try{if(!await y())return{usingModular:!1,capabilities:["basic-auth","user-client"],healthStatus:"degraded"};{let{getAuthenticationCore:e}=await t.e(3249).then(t.bind(t,3249)),r=e();return{usingModular:!0,capabilities:r.manifest.provides.map(e=>e.name),healthStatus:r.isActive?"healthy":"degraded"}}}catch(e){return{usingModular:!1,capabilities:[],healthStatus:"unavailable"}}}t.r(r),t.d(r,{addTeamMember:()=>h,createUserClient:()=>s,default:()=>U,getAuthSystemStatus:()=>w,getCurrentUser:()=>g,getTeamMembers:()=>f,getUserClient:()=>i,getUserPermissions:()=>l,hasPermission:()=>c,isModularAuthAvailable:()=>y,removeTeamMember:()=>b,signInUser:()=>u,signOutUser:()=>d,updateUserClient:()=>o});let U={getUserClient:i,createUserClient:s,updateUserClient:o,getUserPermissions:l,hasPermission:c,signInUser:u,signOutUser:d,getCurrentUser:g,getTeamMembers:f,addTeamMember:h,removeTeamMember:b,isModularAuthAvailable:y,getAuthSystemStatus:w}}}]);